from core_module.scrape.ncar import NcarScrapeDriver, NcarTarget, NcarClouds, NcarScrapeTask, NcarCaptions
from core_module.transfer.baidu import BaiduTransferDriver
from core_module.transfer.aliyun import AliTransferDriver
from core_module.supervisor import TranscrapeSupervisor
from utils.async_io import async_run

# 本案例展示 分享链接爬取-转存
# 需要在async环境下实例化 TranscrapeSupervisor 以及各类接口驱动
async def async_main():
    # 定义分享链接来源
    tasks = [
        NcarScrapeTask(
            'https://mcar.vip/forum.php?mod=viewthread&tid=35942',
            NcarTarget(NcarCaptions.raw, NcarClouds.baidu, '/test/raw/The Neighborhood Season 5 (2022)'),
            NcarTarget(NcarCaptions.chinese, NcarClouds.ali, '/test/中文/The Neighborhood Season 5 (2022)')
        ),
        NcarScrapeTask(
            'https://mcar.vip/forum.php?mod=viewthread&tid=36286',
            NcarTarget(NcarCaptions.raw, NcarClouds.baidu, '/test/raw/Succession Season 4 (2023)'),
            NcarTarget(NcarCaptions.chinese, NcarClouds.ali, '/test/中文/Succession Season 4 (2023)')
        )]

    # 授权信息，仅第一次启动需要，后续只需要读取持久化数据
    ali_auth = 'a******************************b'
    baidu_cookies = 'XFI=************************************; XFCS=****************************************************************; XFT=********************************************; BIDUPSID=********************************; PSTM=**********; BAIDUID=********************************:FG=1; PANWEB=1; secu=1; H_WISE_SIDS=**********************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************; H_WISE_SIDS_BFESS=**********************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************; BDUSS=X***********************************************************************************************************************************************************************************************; BDUSS_BFESS=************************************************************************************************************************************************************************************************; ***********************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************'

    # 流程控制器
    async with TranscrapeSupervisor(
            NcarScrapeDriver(),  # 分享链接发布网站的爬虫驱动
            BaiduTransferDriver(baidu_cookies),  # 度盘转存驱动，传入授权cookies
            AliTransferDriver(ali_auth)  # 阿里盘转存驱动，传入refresh_token或access_token（需要以kwarg方式传入）
    ) as supervisor:

        supervisor.submit(*tasks)  # 创建 爬取链接-转存 的异步任务，只有不存在批量请求优化的任务会在此时开始执行
        supervisor.start_all()  # 开始所有 爬取链接-转存 的异步任务，具备批量请求优化的任务会在此时批量执行
        supervisor.start_update_status()  # 开始打印实时任务状态更新
        supervisor.await_all()  # 等待所有任务完成


if __name__ == '__main__':
    async_run(async_main())
